<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Substitution Cipher Analysis Workbench</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-mobile.css">
  <link rel="stylesheet" href="style-tablet.css" media="(min-width: 600px)">
  <link rel="stylesheet" href="style-laptop.css" media="(min-width: 900px)">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>Substitution Cipher Analysis Workbench</h1>
        <p class="subtitle">手動による換字式暗号解析支援ツール</p>
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn-small" id="btnSave" title="作業状態を保存 (Ctrl+S)">保存</button>
        <button type="button" class="btn btn-small btn-secondary" id="btnLoad" title="作業状態を読込">読込</button>
        <button type="button" class="btn-help" id="btnHelp" title="ヘルプ (?)">ヘルプ</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 暗号文入力エリア -->
    <section class="input-section">
      <div class="input-header">
        <h2>暗号文入力</h2>
        <div class="legend">
          <span class="legend-item"><span class="legend-upper">A-Z</span>: 未解読</span>
          <span class="legend-item"><span class="legend-lower">a-z</span>: 解読済み</span>
        </div>
      </div>
      <textarea id="cipherInput" class="cipher-input" placeholder="暗号文を入力してください..." rows="6"></textarea>
      <div class="input-controls">
        <div class="input-buttons">
          <button type="button" class="btn" id="btnNormalize" title="大文字化・記号除去">正規化</button>
          <button type="button" class="btn btn-secondary" id="btnClear">クリア</button>
          <button type="button" class="btn btn-secondary" id="btnCopy" title="クリップボードにコピー">コピー</button>
        </div>
        <div class="char-counter">
          <span id="charCount">0</span> 文字
        </div>
      </div>
    </section>

    <!-- 文字マッピング管理 -->
    <section class="mapping-section">
      <div class="mapping-header">
        <h2>文字マッピング</h2>
        <div class="mapping-actions">
          <button type="button" class="btn btn-small" id="btnApplyMapping" title="マッピングを適用 (Ctrl+M)">適用</button>
          <button type="button" class="btn btn-small btn-secondary" id="btnClearMapping">リセット</button>
        </div>
      </div>
      <div class="mapping-grid" id="mappingGrid">
        <!-- A-Z mapping inputs generated by JS -->
      </div>
    </section>

    <!-- フェーズナビゲーション -->
    <nav class="phase-nav">
      <button type="button" class="phase-btn active" data-phase="1" title="概観 (1)">
        <span class="phase-num">1</span>
        <span class="phase-name">概観</span>
      </button>
      <button type="button" class="phase-btn" data-phase="2" title="仮説生成 (2)">
        <span class="phase-num">2</span>
        <span class="phase-name">仮説生成</span>
      </button>
      <button type="button" class="phase-btn" data-phase="3" title="仮説検証 (3)">
        <span class="phase-num">3</span>
        <span class="phase-name">仮説検証</span>
      </button>
      <button type="button" class="phase-btn" data-phase="4" title="上級分析 (4)">
        <span class="phase-num">4</span>
        <span class="phase-name">上級</span>
      </button>
    </nav>

    <!-- タブナビゲーション -->
    <nav class="tab-nav" id="tabNav">
      <!-- Phase 1 tabs -->
      <div class="tab-group" data-phase="1">
        <button type="button" class="tab-btn active" data-tab="statistics">統計</button>
        <button type="button" class="tab-btn" data-tab="ic">一致指数</button>
        <button type="button" class="tab-btn" data-tab="spacing">単語間隔</button>
        <button type="button" class="tab-btn" data-tab="repeated">繰り返し</button>
      </div>
      <!-- Phase 2 tabs -->
      <div class="tab-group hidden" data-phase="2">
        <button type="button" class="tab-btn" data-tab="wordHints">単語ヒント</button>
        <button type="button" class="tab-btn" data-tab="frequency">頻度分析</button>
      </div>
      <!-- Phase 3 tabs -->
      <div class="tab-group hidden" data-phase="3">
        <button type="button" class="tab-btn" data-tab="ngrams">N-gram</button>
        <button type="button" class="tab-btn" data-tab="pattern">パターン</button>
      </div>
      <!-- Phase 4 tabs (Advanced) -->
      <div class="tab-group hidden" data-phase="4">
        <button type="button" class="tab-btn" data-tab="kasiski">Kasiski</button>
      </div>
    </nav>

    <!-- タブコンテンツ -->
    <div class="tab-content">
      <!-- Statistics Tab -->
      <section class="tab-panel active" id="panel-statistics">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">暗号文の基本的な統計情報を表示します。文字数、種類別のカウント、解読進捗を確認できます。</p>
            <p class="panel-next">次に見るべき: 一致指数タブでIC値を確認し、暗号の種類を推測</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="statistics" title="英文の参考データ">📖 資料</button>
            <button type="button" class="btn btn-run" data-analysis="statistics">分析実行</button>
            <span class="last-run" id="lastRun-statistics">未実行</span>
          </div>
        </div>
        <div class="panel-body" id="result-statistics">
          <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
        </div>
      </section>

      <!-- IC Tab -->
      <section class="tab-panel" id="panel-ic">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">一致指数（Index of Coincidence）を計算し、参照範囲と比較します。</p>
            <p class="panel-next">次に見るべき: IC値が高ければ単一換字式の可能性、低ければ多表式の可能性</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="ic" title="IC値の参考データ">📖 資料</button>
            <a href="https://ipusiron.github.io/ic-learning-visualizer/" target="_blank" rel="noopener noreferrer" class="btn btn-small btn-secondary btn-external">IC Learning Visualizer</a>
            <button type="button" class="btn btn-run" data-analysis="ic">分析実行</button>
            <span class="last-run" id="lastRun-ic">未実行</span>
          </div>
        </div>
        <div class="panel-body" id="result-ic">
          <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
        </div>
      </section>

      <!-- Word Spacing Tab -->
      <section class="tab-panel" id="panel-spacing">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">スペースの存在と信頼性を検出し、単語長の分布を分析します。</p>
            <p class="panel-next">次に見るべき: 単語ヒントタブで1文字単語や頻出単語を確認</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="spacing" title="単語長の参考データ">📖 資料</button>
            <button type="button" class="btn btn-run" data-analysis="spacing">分析実行</button>
            <span class="last-run" id="lastRun-spacing">未実行</span>
          </div>
        </div>
        <div class="panel-body split-view" id="result-spacing">
          <div class="result-table">
            <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
          </div>
          <div class="cipher-viewer" id="viewer-spacing">
            <div class="viewer-controls">
              <button type="button" class="btn btn-small btn-toggle" id="btnToggleSpacing">スペース位置表示</button>
            </div>
            <pre class="viewer-text" id="viewerText-spacing"></pre>
          </div>
        </div>
      </section>

      <!-- Repeated Sequences Tab -->
      <section class="tab-panel" id="panel-repeated">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">繰り返し出現する部分文字列を検出します。クリックでハイライト表示。</p>
            <p class="panel-next">次に見るべき: 繰り返しパターンから共通単語や接辞を推測</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="repeated" title="繰り返しパターンの参考データ">📖 資料</button>
            <button type="button" class="btn btn-run" data-analysis="repeated">分析実行</button>
            <span class="last-run" id="lastRun-repeated">未実行</span>
          </div>
        </div>
        <div class="panel-body split-view" id="result-repeated">
          <div class="result-table">
            <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
          </div>
          <div class="cipher-viewer" id="viewer-repeated">
            <div class="viewer-controls">
              <span class="viewer-hint">表の行をクリック→</span>
              <button type="button" class="btn btn-small" id="btnPrevRepeated" disabled>◀ 前</button>
              <span class="match-counter" id="matchCounter-repeated">-</span>
              <button type="button" class="btn btn-small" id="btnNextRepeated" disabled>次 ▶</button>
              <button type="button" class="btn btn-small btn-toggle" id="btnToggleRepeated">ハイライト</button>
            </div>
            <pre class="viewer-text" id="viewerText-repeated"></pre>
          </div>
        </div>
      </section>

      <!-- Word Hints Tab -->
      <section class="tab-panel" id="panel-wordHints">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">言語制約と統計的ヒントを表示します。1文字単語、頻出単語などを確認できます。</p>
            <p class="panel-next">次に見るべき: 頻度分析で文字の出現頻度を確認</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="wordHints" title="単語の参考データ">📖 資料</button>
            <button type="button" class="btn btn-run" data-analysis="wordHints">分析実行</button>
            <span class="last-run" id="lastRun-wordHints">未実行</span>
          </div>
        </div>
        <div class="panel-body split-view" id="result-wordHints">
          <div class="hints-container">
            <div class="hint-section">
              <h3>言語制約</h3>
              <div id="languageConstraints">
                <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
              </div>
            </div>
            <div class="hint-section">
              <h3>統計的ヒント</h3>
              <div id="statisticalHints">
                <p class="placeholder">-</p>
              </div>
            </div>
          </div>
          <div class="cipher-viewer" id="viewer-wordHints">
            <div class="viewer-controls">
              <button type="button" class="btn btn-small btn-toggle" id="btnToggleWordHints">ハイライト切替</button>
            </div>
            <pre class="viewer-text" id="viewerText-wordHints"></pre>
          </div>
        </div>
      </section>

      <!-- Frequency Analysis Tab -->
      <section class="tab-panel" id="panel-frequency">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">各文字の出現頻度を棒グラフで表示し、英語標準頻度と比較します。</p>
            <p class="panel-next">次に見るべき: e, t, a, o, i, n などの高頻度文字と比較</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="frequency" title="英文頻度の参考データ">📖 資料</button>
            <a href="https://ipusiron.github.io/frequency-analyzer/" target="_blank" rel="noopener noreferrer" class="btn btn-small btn-secondary btn-external">Frequency Analyzer</a>
            <button type="button" class="btn btn-run" data-analysis="frequency">分析実行</button>
            <span class="last-run" id="lastRun-frequency">未実行</span>
          </div>
        </div>
        <div class="panel-body" id="result-frequency">
          <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
        </div>
      </section>

      <!-- N-grams Tab -->
      <section class="tab-panel" id="panel-ngrams">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">2-gram、3-gramの頻度を表示します。TH, HE, IN などの傾向を確認できます。</p>
            <p class="panel-next">注意: これは傾向のみを示します。確定的な情報ではありません。</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="ngrams" title="N-gramの参考データ">📖 資料</button>
            <div class="toggle-switch">
              <button type="button" class="toggle-option active" data-ngram="2">2-gram</button>
              <button type="button" class="toggle-option" data-ngram="3">3-gram</button>
              <button type="button" class="toggle-option" data-ngram="4">4-gram</button>
            </div>
            <button type="button" class="btn btn-run" data-analysis="ngrams">分析実行</button>
            <span class="last-run" id="lastRun-ngrams">未実行</span>
          </div>
        </div>
        <div class="panel-body split-view" id="result-ngrams">
          <div class="result-table">
            <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
          </div>
          <div class="cipher-viewer" id="viewer-ngrams">
            <div class="viewer-controls">
              <span class="viewer-hint">表の行をクリック→</span>
              <button type="button" class="btn btn-small" id="btnPrevNgrams" disabled>◀ 前</button>
              <span class="match-counter" id="matchCounter-ngrams">-</span>
              <button type="button" class="btn btn-small" id="btnNextNgrams" disabled>次 ▶</button>
              <button type="button" class="btn btn-small btn-toggle" id="btnToggleNgrams">ハイライト</button>
            </div>
            <pre class="viewer-text" id="viewerText-ngrams"></pre>
          </div>
        </div>
      </section>

      <!-- Pattern Analysis Tab -->
      <section class="tab-panel" id="panel-pattern">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">パターンワード（121, 122など）と非パターンワードを分析します。</p>
            <p class="panel-next">次に見るべき: 二重文字、可逆ペア（er-re等）にも注目</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="pattern" title="パターンの参考データ">📖 資料</button>
            <button type="button" class="btn btn-run" data-analysis="pattern">分析実行</button>
            <span class="last-run" id="lastRun-pattern">未実行</span>
          </div>
        </div>
        <div class="panel-body split-view" id="result-pattern">
          <div class="pattern-container">
            <div class="pattern-section">
              <h3>パターンワード</h3>
              <div id="patternWords">
                <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
              </div>
            </div>
            <div class="pattern-section">
              <h3>非パターンワード（注目候補）</h3>
              <div id="nonPatternWords">
                <p class="placeholder">-</p>
              </div>
            </div>
            <div class="pattern-section">
              <h3>追加観察</h3>
              <div id="extraObservations">
                <p class="placeholder">-</p>
              </div>
            </div>
          </div>
          <div class="cipher-viewer" id="viewer-pattern">
            <div class="viewer-controls">
              <span class="viewer-hint">パターンをクリック→</span>
              <button type="button" class="btn btn-small" id="btnPrevPattern" disabled>◀ 前</button>
              <span class="match-counter" id="matchCounter-pattern">-</span>
              <button type="button" class="btn btn-small" id="btnNextPattern" disabled>次 ▶</button>
              <button type="button" class="btn btn-small btn-toggle" id="btnTogglePattern">ハイライト</button>
              <select id="highlightColor" class="highlight-color-select" title="ハイライト色">
                <option value="yellow">黄</option>
                <option value="cyan">水色</option>
                <option value="lime">緑</option>
                <option value="pink">ピンク</option>
                <option value="orange">橙</option>
              </select>
            </div>
            <pre class="viewer-text" id="viewerText-pattern"></pre>
          </div>
        </div>
      </section>

      <!-- Kasiski Test Tab -->
      <section class="tab-panel" id="panel-kasiski">
        <div class="panel-header">
          <div class="panel-info">
            <p class="panel-desc">Kasiski（カシスキー）テストで多表式暗号（ヴィジュネル等）の鍵長を推定します。</p>
            <p class="panel-next">注意: 単一換字式の場合はこの分析は不要です。IC値が低い場合に使用してください。</p>
          </div>
          <div class="panel-actions">
            <button type="button" class="btn btn-small btn-ref" data-ref="kasiski" title="Kasiskiの参考データ">📖 資料</button>
            <a href="https://ipusiron.github.io/repeatseq-analyzer/" target="_blank" rel="noopener noreferrer" class="btn btn-small btn-secondary btn-external">RepeatSeq Analyzer</a>
            <button type="button" class="btn btn-run" data-analysis="kasiski">分析実行</button>
            <span class="last-run" id="lastRun-kasiski">未実行</span>
          </div>
        </div>
        <div class="panel-body" id="result-kasiski">
          <p class="placeholder">「分析実行」ボタンを押して解析を開始してください。</p>
        </div>
      </section>
    </div>
  </main>

  <!-- ヘルプモーダル -->
  <div class="modal-overlay hidden" id="helpModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ヘルプ</h2>
        <button type="button" class="btn-close" id="btnCloseHelp">&times;</button>
      </div>
      <div class="modal-body">
        <h3>このツールについて</h3>
        <p>換字式暗号解析ワークベンチは、手動による換字式暗号の解読を支援するツールです。自動解読は行いません。</p>

        <h3>基本ルール</h3>
        <ul>
          <li><strong>A-Z（大文字）</strong>: 未解読の暗号文字</li>
          <li><strong>a-z（小文字）</strong>: 解読済みの平文文字</li>
        </ul>

        <h3>4つのフェーズ</h3>
        <ol>
          <li><strong>概観</strong>: 暗号文の性質を理解する（統計、一致指数、単語間隔、繰り返し）</li>
          <li><strong>仮説生成</strong>: 候補となるマッピングを形成する（単語ヒント、頻度分析）</li>
          <li><strong>仮説検証</strong>: 仮説を全文で検証する（N-gram、パターン分析）</li>
          <li><strong>上級</strong>: 多表式暗号の解析（Kasiskiテスト）</li>
        </ol>

        <h3>文字マッピング</h3>
        <p>マッピング欄に小文字を入力し「適用」ボタンを押すと、暗号文中の該当文字が置換されます。</p>

        <h3>キーボードショートカット</h3>
        <table class="shortcut-table">
          <tr><td><kbd>1</kbd>-<kbd>4</kbd></td><td>フェーズ切替</td></tr>
          <tr><td><kbd>Ctrl</kbd>+<kbd>S</kbd></td><td>作業状態を保存</td></tr>
          <tr><td><kbd>Ctrl</kbd>+<kbd>M</kbd></td><td>マッピングを適用</td></tr>
          <tr><td><kbd>Ctrl</kbd>+<kbd>Enter</kbd></td><td>現在のタブで分析実行</td></tr>
          <tr><td><kbd>?</kbd></td><td>ヘルプ表示</td></tr>
          <tr><td><kbd>Esc</kbd></td><td>モーダルを閉じる</td></tr>
        </table>

        <h3>使い方</h3>
        <ol>
          <li>暗号文を入力エリアに貼り付け</li>
          <li>各タブで「分析実行」ボタンをクリック</li>
          <li>結果を参考に、文字マッピングを設定</li>
          <li>「適用」で暗号文に反映し解読を進める</li>
        </ol>

        <p class="note">※ すべての出力はヒントや傾向であり、確定的な答えではありません。</p>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer">
      🔗 GitHubリポジトリはこちら（ <a href="https://github.com/ipusiron/substitution-cipher-analysis-workbench" target="_blank" rel="noopener noreferrer">ipusiron/substitution-cipher-analysis-workbench</a> ）
    </div>
  </footer>

  <!-- 資料モーダル -->
  <div class="modal-overlay hidden" id="refModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="refModalTitle">参考資料</h2>
        <button type="button" class="btn-close" id="btnCloseRef">&times;</button>
      </div>
      <div class="modal-body" id="refModalBody">
        <!-- Content populated by JS -->
      </div>
    </div>
  </div>

  <!-- 保存確認通知 -->
  <div class="toast hidden" id="toast"></div>

  <script src="script.js"></script>
</body>
</html>
